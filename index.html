<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ø§Ù„ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(45deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            padding-bottom: 90px;
            color: #fff;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 15px;
            color: white;
            transition: transform 0.2s;
        }
        
        .glass-input, .glass-select, textarea {
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #fff !important;
        }
        
        .glass-input::placeholder, textarea::placeholder { color: rgba(255, 255, 255, 0.7); }
        .glass-input:focus, textarea:focus {
            background: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        /* ØªØ®ØµÙŠØµ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-glass {
            color: white;
            border-color: rgba(255,255,255,0.2);
        }
        .table-glass th, .table-glass td {
            background: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            vertical-align: middle;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex; justify-content: space-around;
            padding: 10px 0; z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .nav-item { text-align: center; color: rgba(255,255,255,0.6); cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item.active { color: #fff; transform: scale(1.1); text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .nav-icon { font-size: 1.4rem; display: block; }
        .nav-text { font-size: 0.7rem; }

        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .balance-pos { color: #76ff03; font-weight: bold; } /* ÙŠØ·Ù„Ø¨Ù†Ø§ */
        .balance-neg { color: #ff5252; font-weight: bold; } /* Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ† */

        option { background-color: #333; color: white; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .worker-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .worker-name-click { cursor: pointer; font-weight: bold; font-size: 1.1rem; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-content-glass {
            background: rgba(40, 40, 60, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 15px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ø§Ù„ Ù„Ù„Ø­Ø¶ÙˆØ± */
        .selected-workers-list span {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

<div class="container py-4">

    <div id="tab-home" class="tab-content active">
        <h3 class="text-center mb-4 fw-bold">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</h3>
        
        <div class="glass-card p-3">
            <h6 class="mb-2">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ…:</h6>
            <div class="mb-2">
                <input type="date" id="attendanceDate" class="form-control glass-input">
            </div>
            <div class="input-group mb-2">
                <select id="workerAttendanceSelect" class="form-select glass-select">
                    <option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù„Ø§Ù‹...</option>
                </select>
                <button class="btn btn-warning" onclick="addToTempList()">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>
            
            <div id="tempWorkersDisplay" class="selected-workers-list mb-3"></div>
            
            <button class="btn btn-success w-100 fw-bold" onclick="saveBatchAttendance()">Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± âœ…</button>
        </div>

        <div class="glass-card p-3 text-center mb-3">
            <h6 class="mb-2 text-white-50">ØµØ§ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ (Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„)</h6>
            <h2 id="grandTotalDisplay" class="fw-bold m-0 text-white">0 Ø¯.Ø¹</h2>
        </div>

        <div class="glass-card p-3">
            <div class="table-responsive">
                <table class="table table-glass text-center mb-0">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="mainTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-notes" class="tab-content">
        <h3 class="text-center mb-4 fw-bold">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
        
        <div class="glass-card p-3">
            <label class="mb-2">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
            <textarea id="noteText" class="form-control glass-input mb-2" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ù†Ø§..."></textarea>
            <button class="btn btn-primary w-100" onclick="addNote()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        </div>

        <div id="notesList">
            </div>
    </div>

    <div id="tab-workers" class="tab-content">
        <h3 class="text-center mb-4 fw-bold">ğŸ‘· Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ø³Ù„Ù</h3>
        <div class="glass-card p-2" id="manageWorkersList"></div>
    </div>

    <div id="tab-add" class="tab-content">
        <h3 class="text-center mb-4 fw-bold">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„</h3>
        <div class="glass-card p-4">
            <div class="mb-4">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„:</label>
                <input type="text" id="newWorkerName" class="form-control glass-input form-control-lg" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§...">
            </div>
            <div class="mb-4">
                <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¯.Ø¹):</label>
                <input type="number" id="newWorkerWage" class="form-control glass-input" placeholder="Ù…Ø«Ù„Ø§Ù‹ 25000">
            </div>
            <button class="btn btn-light w-100 btn-lg fw-bold" style="color: #333;" onclick="addNewWorker()">Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ù…Ù„ âœ…</button>
        </div>
    </div>

</div>

<div class="modal fade" id="loanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-glass">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù: <span id="loanWorkerName"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h4 class="mb-2">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ù„Ù</h4>
                <h2 id="totalLoanDisplay" class="text-danger fw-bold mb-4">0 Ø¯.Ø¹</h2>
                
                <hr class="border-light">
                
                <h6 class="text-start">Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©:</h6>
                <input type="date" id="loanDate" class="form-control glass-input mb-2">
                <input type="number" id="loanAmount" class="form-control glass-input mb-2" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ">
                <button class="btn btn-warning w-100 mb-3 fw-bold" onclick="saveLoan()">Ø­ÙØ¸ Ø§Ù„Ø³Ù„ÙØ©</button>
                
                <div class="table-responsive mb-3" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-glass table-sm text-center">
                        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                        <tbody id="loanListBody"></tbody>
                    </table>
                </div>

                <button class="btn btn-outline-danger w-100" onclick="resetLoans()">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø³Ù„Ù</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-glass">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group" id="workDatesList" style="max-height: 300px; overflow-y: auto;"></ul>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home', this)">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>
    <div class="nav-item" onclick="switchTab('notes', this)">
        <span class="nav-icon">ğŸ“</span>
        <span class="nav-text">Ù…Ù„Ø§Ø­Ø¸Ø©</span>
    </div>
    <div class="nav-item" onclick="switchTab('workers', this)">
        <span class="nav-icon">ğŸ‘·</span>
        <span class="nav-text">Ø§Ù„Ø¹Ù…Ø§Ù„</span>
    </div>
    <div class="nav-item" onclick="switchTab('add', this)">
        <span class="nav-icon">â•</span>
        <span class="nav-text">Ø¥Ø¶Ø§ÙØ©</span>
    </div>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===
    // history types: 'wage' (Ø­Ø¶ÙˆØ±), 'loan' (Ø³Ù„ÙØ©)
    let workers = JSON.parse(localStorage.getItem('workersApp_Mod_v1')) || [];
    let notes = JSON.parse(localStorage.getItem('notesApp_v1')) || [];
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø¤Ù‚ØªØ©
    let tempAttendanceList = [];
    let currentLoanWorkerIndex = null;

    const loanModal = new bootstrap.Modal(document.getElementById('loanModal'));
    const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

    window.onload = function() {
        document.getElementById('attendanceDate').valueAsDate = new Date();
        document.getElementById('loanDate').valueAsDate = new Date();
        renderMainTable();
        updateWorkerSelect();
        renderNotes();
        renderWorkersManagement();
    };

    function formatMoney(amount) {
        return parseFloat(amount).toLocaleString('en-US') + ' Ø¯.Ø¹';
    }

    function saveData() {
        localStorage.setItem('workersApp_Mod_v1', JSON.stringify(workers));
        localStorage.setItem('notesApp_v1', JSON.stringify(notes));
    }

    function switchTab(tabName, navElement) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navElement.classList.add('active');
        
        if(tabName === 'home') { renderMainTable(); updateWorkerSelect(); }
        if(tabName === 'workers') renderWorkersManagement();
    }

    // === 1. Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ ===
    function addNewWorker() {
        const name = document.getElementById('newWorkerName').value.trim();
        const wage = document.getElementById('newWorkerWage').value;
        
        if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…!");
        
        workers.push({ 
            name: name, 
            defaultWage: wage ? parseFloat(wage) : 25000,
            history: [] // { date, type: 'wage'|'loan', amount }
        });
        saveData();
        
        document.getElementById('newWorkerName').value = '';
        document.getElementById('newWorkerWage').value = '';
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ù…Ù„ âœ…");
        updateWorkerSelect();
    }

    // === 2. Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯) ===
    function updateWorkerSelect() {
        const select = document.getElementById('workerAttendanceSelect');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù„Ø§Ù‹...</option>';
        workers.forEach((w, i) => {
            select.innerHTML += `<option value="${i}">${w.name}</option>`;
        });
    }

    function addToTempList() {
        const select = document.getElementById('workerAttendanceSelect');
        const index = select.value;
        if(index === "") return;
        
        const workerName = workers[index].name;
        
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if(!tempAttendanceList.includes(index)) {
            tempAttendanceList.push(index);
            const display = document.getElementById('tempWorkersDisplay');
            display.innerHTML += `<span>${workerName}</span>`;
        }
        select.value = "";
    }

    function saveBatchAttendance() {
        const date = document.getElementById('attendanceDate').value;
        if(!date) return alert("Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹");
        if(tempAttendanceList.length === 0) return alert("Ø§Ø®ØªØ± Ø¹Ù…Ø§Ù„Ø§Ù‹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©");

        tempAttendanceList.forEach(index => {
            let worker = workers[index];
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± (wage)
            worker.history.push({
                date: date,
                type: 'wage',
                amount: worker.defaultWage || 25000
            });
        });

        saveData();
        tempAttendanceList = [];
        document.getElementById('tempWorkersDisplay').innerHTML = '';
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        renderMainTable();
    }

    function renderMainTable() {
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';
        
        let grandTotal = 0;

        workers.forEach((worker, index) => {
            // Ø­Ø³Ø§Ø¨Ø§Øª
            let totalWages = 0;
            let totalLoans = 0;
            let daysCount = 0;

            worker.history.forEach(h => {
                if(h.type === 'wage') {
                    totalWages += h.amount;
                    daysCount++;
                } else if(h.type === 'loan') {
                    totalLoans += h.amount;
                }
            });

            // Ø§Ù„Ø±ØµÙŠØ¯ = Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª (ÙŠØ·Ù„Ø¨Ù†Ø§) - Ø§Ù„Ø³Ù„Ù (Ø¹Ù„ÙŠÙ‡)
            let netBalance = totalWages - totalLoans;
            grandTotal += netBalance;

            let colorClass = netBalance >= 0 ? 'balance-pos' : 'balance-neg'; // Ø£Ø®Ø¶Ø± Ø§Ø°Ø§ ÙŠØ·Ù„Ø¨Ù†Ø§ØŒ Ø£Ø­Ù…Ø± Ø§Ø°Ø§ Ø¹Ù„ÙŠÙ‡
            
            tbody.innerHTML += `
                <tr>
                    <td>${worker.name}</td>
                    <td>${daysCount} Ø£ÙŠØ§Ù…</td>
                    <td class="${colorClass}" style="direction:ltr">${formatMoney(netBalance)}</td>
                    <td><button class="btn btn-sm btn-info text-white" onclick="showWorkDetails(${index})">ğŸ‘ï¸</button></td>
                </tr>
            `;
        });

        const totalEl = document.getElementById('grandTotalDisplay');
        totalEl.innerText = formatMoney(grandTotal);
        totalEl.className = grandTotal >= 0 ? "fw-bold m-0 balance-pos" : "fw-bold m-0 balance-neg";
    }

    function showWorkDetails(index) {
        const list = document.getElementById('workDatesList');
        list.innerHTML = '';
        const worker = workers[index];
        
        // ØªØµÙÙŠØ© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ ÙÙ‚Ø·
        const workDays = worker.history.filter(h => h.type === 'wage');
        
        if(workDays.length === 0) {
            list.innerHTML = '<li class="list-group-item bg-transparent text-white text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ Ù…Ø³Ø¬Ù„Ø©</li>';
        } else {
            // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ
            [...workDays].reverse().forEach(d => {
                list.innerHTML += `
                    <li class="list-group-item bg-transparent text-white border-light d-flex justify-content-between">
                        <span>ğŸ“… ${d.date}</span>
                        <span class="text-success">+ ${formatMoney(d.amount)}</span>
                    </li>`;
            });
        }
        detailsModal.show();
    }

    // === 3. Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ===
    function addNote() {
        const txt = document.getElementById('noteText').value;
        if(!txt) return;
        
        const noteObj = {
            id: Date.now(),
            text: txt,
            date: new Date().toLocaleDateString('ar-EG')
        };
        notes.unshift(noteObj); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        saveData();
        document.getElementById('noteText').value = '';
        renderNotes();
    }

    function renderNotes() {
        const container = document.getElementById('notesList');
        container.innerHTML = '';
        if(notes.length === 0) {
            container.innerHTML = '<div class="text-center text-white-50 mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>';
            return;
        }
        
        notes.forEach((note) => {
            container.innerHTML += `
                <div class="glass-card p-3 d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-warning">${note.date}</small>
                        <p class="m-0 mt-1">${note.text}</p>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteNote(${note.id})">ğŸ—‘ï¸</button>
                </div>
            `;
        });
    }

    function deleteNote(id) {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ")) {
            notes = notes.filter(n => n.id !== id);
            saveData();
            renderNotes();
        }
    }

    // === 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ø³Ù„Ù (Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ù„Ø²Ø±) ===
    function renderWorkersManagement() {
        const container = document.getElementById('manageWorkersList');
        container.innerHTML = '';
        
        if(workers.length === 0) {
            container.innerHTML = '<div class="text-center p-3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ø§Ù„.</div>';
            return;
        }

        workers.forEach((worker, index) => {
            container.innerHTML += `
                <div class="worker-list-item">
                    <span class="fw-bold">ğŸ‘¤ ${worker.name}</span>
                    <div>
                        <button class="btn btn-sm btn-warning ms-1" onclick="openLoanModal(${index})">Ø§Ù„Ø³Ù„ÙØ© ğŸ’°</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWorker(${index})">Ø­Ø°Ù ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
        });
    }

    function deleteWorker(index) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ")) {
            workers.splice(index, 1);
            saveData();
            renderWorkersManagement();
            renderMainTable();
            updateWorkerSelect();
        }
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ù„Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ---
    function openLoanModal(index) {
        currentLoanWorkerIndex = index;
        const worker = workers[index];
        document.getElementById('loanWorkerName').innerText = worker.name;
        document.getElementById('loanDate').valueAsDate = new Date(); // reset date
        document.getElementById('loanAmount').value = ''; // reset amount
        
        renderLoanData();
        loanModal.show();
    }

    function renderLoanData() {
        const worker = workers[currentLoanWorkerIndex];
        const tbody = document.getElementById('loanListBody');
        tbody.innerHTML = '';
        
        let totalLoans = 0;
        const loans = worker.history.filter(h => h.type === 'loan');

        [...loans].reverse().forEach(l => {
            totalLoans += l.amount;
            tbody.innerHTML += `
                <tr>
                    <td>${l.date}</td>
                    <td>${formatMoney(l.amount)}</td>
                </tr>
            `;
        });

        document.getElementById('totalLoanDisplay').innerText = formatMoney(totalLoans);
    }

    function saveLoan() {
        const amount = parseFloat(document.getElementById('loanAmount').value);
        const date = document.getElementById('loanDate').value;
        
        if(!amount || !date) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº");

        workers[currentLoanWorkerIndex].history.push({
            date: date,
            type: 'loan',
            amount: amount
        });
        
        saveData();
        document.getElementById('loanAmount').value = '';
        renderLoanData();
        renderMainTable(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    }

    function resetLoans() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ (Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„Ù ÙÙ‚Ø·)")) {
            // Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ Ù†ÙˆØ¹Ù‡Ø§ 'loan' Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…Ù„
            workers[currentLoanWorkerIndex].history = workers[currentLoanWorkerIndex].history.filter(h => h.type !== 'loan');
            saveData();
            renderLoanData();
            renderMainTable();
        }
    }

</script>

</body>
</html>
